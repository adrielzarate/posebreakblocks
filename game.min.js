const videoWidth=600,videoHeight=600,video=document.getElementById("myVideo"),imageScaleFactor=.5,outputStride=16,flipHorizontal=!1;async function setupCamera(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Browser API navigator.mediaDevices.getUserMedia not available");video.width=videoWidth,video.height=videoHeight;const t=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"user",width:videoWidth,height:videoHeight}});return video.srcObject=t,new Promise(t=>{video.onloadedmetadata=(()=>{t(video)})})}async function loadVideo(){const t=await setupCamera();return t.play(),t}loadVideo();const DOMboxes=document.getElementById("boxes"),DOMscore=document.getElementById("score"),canvas=document.getElementById("myCanvas"),ctx=canvas.getContext("2d"),upArrow=new Image;upArrow.src="up.png";const downArrow=new Image;downArrow.src="down.png";const leftArrow=new Image;leftArrow.src="left.png";const rightArrow=new Image;rightArrow.src="right.png";const w=canvas.width,h=canvas.height,centerX=w/2,centerY=h/2,breakableZoneStart=centerX,breakableRightZoneEnd=centerX+centerX/1.5,breakableLeftZoneEnd=centerX-centerX/1.5;let direction,boxes=0,score=0,oldX=0,oldY=0,xDirection="",yDirection="",movements=[];function mostDirection(t){var o,e,i=1,n=[],a=t[0];for(o=0;o<t.length;o++)n[e=t[o]]?++n[e]>i&&(i=n[o],a=e):n[e]=1;return a}function getDirection(t){xDirection=oldX<t.x?"right":"left",yDirection=oldY<t.y?"down":"up",Math.abs(t.y-oldY)>Math.abs(t.x-oldX)?movements.push(yDirection):movements.push(xDirection),oldX=t.x,oldY=t.y}const breakDirections=["toUp","toDown","toRight","toLeft"],directions=["right","left"];function showGameData(){DOMboxes.textContent=boxes,DOMscore.textContent=score}function drawScene(){ctx.lineWidth="1",ctx.strokeStyle="#999999",ctx.beginPath(),ctx.moveTo(centerX,centerY),ctx.lineTo(0,0),ctx.lineTo(w,0),ctx.lineTo(centerX,centerY),ctx.lineTo(w,h),ctx.lineTo(0,h),ctx.lineTo(centerX,centerY),ctx.closePath(),ctx.stroke()}function ctxDrawImage(t,o,e,i,n){ctx.drawImage(t,o,e,i,n)}function Box(){this.x=centerX,this.y=centerY,this.breakDirection=breakDirections[Math.floor(Math.random()*breakDirections.length)],this.direction=directions[Math.floor(Math.random()*directions.length)],this.speed=4,this.w=this.h=1,this.isHandInside=!1}Box.prototype.updatePosition=function(){"right"===this.direction?this.x+=this.speed:this.x-=2*this.speed,this.w+=this.speed,this.y=centerY-this.h/2,this.h+=this.speed,this.drawBox()},Box.prototype.drawBox=function(){ctx.beginPath(),ctx.fillStyle="transparent";let t=null;switch(this.breakDirection){case"toUp":t=downArrow;break;case"toDown":t=upArrow;break;case"toRight":t=leftArrow;break;case"toLeft":t=rightArrow}ctxDrawImage(t,this.x,this.y,this.w,this.h),ctx.fillRect(this.x,this.y,this.w,this.h),this.isBreakable()&&(ctx.lineWidth="4",ctx.strokeStyle="black",ctx.rect(this.x,this.y,this.w,this.h),ctx.stroke())},Box.prototype.isBreakable=function(t){return this.direction,!0},Box.prototype.isOutOfScreen=function(){return this.x>w||this.x+this.w<0};let aBox=new Box;const rightHandPosition={x:null,y:null},leftHandPosition={x:null,y:null};function draw(t){ctx.clearRect(0,0,w,h),drawScene(),ctx.beginPath(),ctx.strokeStyle="#000",ctx.lineWidth="2",ctx.lineTo(t[1].position.x,t[1].position.y),ctx.lineTo(t[2].position.x,t[2].position.y),ctx.moveTo(t[5].position.x,t[5].position.y),ctx.lineTo(t[6].position.x,t[6].position.y),ctx.moveTo(t[6].position.x,t[6].position.y),ctx.lineTo(t[8].position.x,t[8].position.y),ctx.lineTo(t[10].position.x,t[10].position.y),ctx.moveTo(t[5].position.x,t[5].position.y),ctx.lineTo(t[7].position.x,t[7].position.y),ctx.lineTo(t[9].position.x,t[9].position.y),ctx.stroke(),ctx.beginPath(),ctx.fillStyle="#000",ctx.arc(t[10].position.x,t[10].position.y,10,0,2*Math.PI),ctx.arc(t[9].position.x,t[9].position.y,10,0,2*Math.PI),ctx.fill(),rightHandPosition.x=t[10].position.x,rightHandPosition.y=t[10].position.y,leftHandPosition.x=t[9].position.x,leftHandPosition.y=t[9].position.y,"right"===aBox.direction?getDirection(rightHandPosition):getDirection(leftHandPosition),direction=mostDirection(movements),movements=[],aBox.updatePosition(),"right"===aBox.direction?tryToBreak(leftHandPosition):tryToBreak(rightHandPosition),aBox.isOutOfScreen()&&(aBox=new Box,boxes++),showGameData()}function resetGame(t){aBox=new Box}function boxBroken(){score++,boxes++,resetGame()}function tryToBreak(t){!1===aBox.isHandInside&&t.y>aBox.y&&t.y<aBox.y+aBox.h&&t.x>aBox.x&&t.x<aBox.x+aBox.w&&(aBox.isHandInside=!0),"toUp"===aBox.breakDirection&&aBox.isBreakable()&&aBox.isHandInside&&"down"===direction&&t.y>aBox.y+aBox.h&&t.x>aBox.x&&t.x<aBox.x+aBox.w&&boxBroken(),"toDown"===aBox.breakDirection&&aBox.isBreakable()&&aBox.isHandInside&&"up"===direction&&t.y<aBox.y&&t.x>aBox.x&&t.x<aBox.x+aBox.w&&boxBroken(),"toRight"===aBox.breakDirection&&aBox.isBreakable()&&aBox.isHandInside&&"left"===direction&&t.x<aBox.x&&t.y>aBox.y&&t.y<aBox.y+aBox.h&&boxBroken(),"toLeft"===aBox.breakDirection&&aBox.isBreakable()&&aBox.isHandInside&&"right"===direction&&t.x>aBox.x+aBox.w&&t.y>aBox.y&&t.y<aBox.y+aBox.h&&boxBroken()}posenet.load().then(function(t){video.play(),setInterval(()=>{t.estimatePoses(video,!1,16).then(function(t){draw(t[0].keypoints)})},60)}).catch(t=>{console.log(t.message)});